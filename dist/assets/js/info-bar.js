function formatExchangeRate(e){return null==e||isNaN(e)?"--":Number(e).toFixed(2)}function formatTemperature(e){return null==e||isNaN(e)?"--°C":`${Math.round(e)}°C`}function formatTime12Hour(e){if(!(e instanceof Date)||isNaN(e.getTime()))return"--:-- --";let t=e.getHours();const a=e.getMinutes(),r=t>=12?"PM":"AM";t%=12,t=t||12;return`${t}:${a<10?"0"+a:a} ${r}`}function formatDateShort(e){if(!(e instanceof Date)||isNaN(e.getTime()))return"--- --, ----";return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]} ${e.getDate()}, ${e.getFullYear()}`}function formatCurrencyDisplay(e,t){return`${e} ${formatExchangeRate(t)}`}const CacheManager={serialize:e=>JSON.stringify({data:e,timestamp:Date.now()}),deserialize(e){try{return JSON.parse(e)}catch(e){return console.error("CacheManager: Failed to deserialize",e),null}},validate(e,t){if(!e||"object"!=typeof e)return!1;if("number"!=typeof e.timestamp)return!1;if(!("data"in e))return!1;if(t&&t.requiredFields)for(const a of t.requiredFields)if(!(a in e.data))return!1;return!0},get(e){try{const t=localStorage.getItem(e);if(!t)return null;const a=this.deserialize(t);return a||null}catch(e){return console.error("CacheManager: Failed to get cache",e),null}},set(e,t,a){try{const r={data:t,timestamp:Date.now(),ttl:a};localStorage.setItem(e,JSON.stringify(r))}catch(e){console.error("CacheManager: Failed to set cache",e)}},isExpired:e=>!(e&&e.timestamp&&e.ttl)||Date.now()-e.timestamp>e.ttl},CONFIG={EXCHANGE_RATE_TTL:18e5,WEATHER_TTL:9e5,TIME_UPDATE_INTERVAL:1e3,SOLANO_LAT:16.5167,SOLANO_LON:121.1833,CURRENCIES:["USD","GBP","SAR","AED","JPY","CAD","AUD"],CACHE_KEYS:{EXCHANGE_RATES:"infobar_exchange_rates",WEATHER:"infobar_weather"}},ExchangeRateService={async fetchRates(){try{const e=CONFIG.CURRENCIES.join(","),t=await fetch(`https://api.exchangerate.host/latest?base=PHP&symbols=${e}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();if(!a.success&&a.rates)return this.processRates(a.rates);if(a.rates)return this.processRates(a.rates);throw new Error("Invalid API response")}catch(e){return console.error("ExchangeRateService: Failed to fetch rates",e),this.fetchRatesFallback()}},async fetchRatesFallback(){try{const e=await fetch("https://open.er-api.com/v6/latest/PHP");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();if(t.rates)return this.processRates(t.rates);throw new Error("Invalid fallback API response")}catch(e){return console.error("ExchangeRateService: Fallback also failed",e),null}},processRates(e){const t={};for(const a of CONFIG.CURRENCIES)void 0!==e[a]?t[a]=e[a]>0?1/e[a]:null:t[a]=null;return{rates:t,timestamp:Date.now(),base:"PHP"}},getCachedRates(){const e=CacheManager.get(CONFIG.CACHE_KEYS.EXCHANGE_RATES);return e&&!CacheManager.isExpired(e)?e.data:null},cacheRates(e){CacheManager.set(CONFIG.CACHE_KEYS.EXCHANGE_RATES,e,CONFIG.EXCHANGE_RATE_TTL)},async getRates(){const e=this.getCachedRates();if(e)return e;const t=await this.fetchRates();return t?(this.cacheRates(t),t):{rates:CONFIG.CURRENCIES.reduce((e,t)=>(e[t]=null,e),{}),timestamp:Date.now(),base:"PHP"}}},WeatherService={async fetchWeather(){try{const e=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.SOLANO_LAT}&longitude=${CONFIG.SOLANO_LON}&current_weather=true`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();if(t.current_weather&&"number"==typeof t.current_weather.temperature)return{temperature:t.current_weather.temperature,timestamp:Date.now(),location:{lat:CONFIG.SOLANO_LAT,lon:CONFIG.SOLANO_LON,name:"Solano, Nueva Vizcaya"}};throw new Error("Invalid weather API response")}catch(e){return console.error("WeatherService: Failed to fetch weather",e),null}},getCachedWeather(){const e=CacheManager.get(CONFIG.CACHE_KEYS.WEATHER);return e&&!CacheManager.isExpired(e)?e.data:null},cacheWeather(e){CacheManager.set(CONFIG.CACHE_KEYS.WEATHER,e,CONFIG.WEATHER_TTL)},async getWeather(){const e=this.getCachedWeather();if(e)return e;const t=await this.fetchWeather();return t?(this.cacheWeather(t),t):{temperature:null,timestamp:Date.now(),location:{lat:CONFIG.SOLANO_LAT,lon:CONFIG.SOLANO_LON,name:"Solano, Nueva Vizcaya"}}}},TimeService={getCurrentPHTDate(){const e=new Date,t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t+288e5)},getCurrentPHT(){return formatTime12Hour(this.getCurrentPHTDate())},getCurrentPHTDate_Formatted(){return formatDateShort(this.getCurrentPHTDate())}},InfoBarManager={intervals:{time:null,weather:null,exchangeRates:null,rateRotation:null},currentRateIndex:0,currentRates:null,async init(){this.renderLoading(),await this.updateAll(),this.startUpdates()},renderLoading(){this.renderTime()},async updateAll(){await Promise.all([this.updateExchangeRates(),this.updateWeather()]),this.renderTime()},async updateExchangeRates(){const e=await ExchangeRateService.getRates();this.currentRates=e,this.renderCurrentRate()},async updateWeather(){const e=await WeatherService.getWeather();this.renderWeather(e)},renderCurrentRate(){const e=document.querySelector(".rate-display");if(!e||!this.currentRates||!this.currentRates.rates)return;const t=CONFIG.CURRENCIES[this.currentRateIndex],a=formatExchangeRate(this.currentRates.rates[t]);e.style.animation="none",e.offsetHeight,e.style.animation="rateFadeIn 0.4s ease-out",e.textContent=`1 ${t} = ₱ ${a}`},rotateRate(){this.currentRateIndex=(this.currentRateIndex+1)%CONFIG.CURRENCIES.length,this.renderCurrentRate()},renderExchangeRates(e){this.currentRates=e,this.renderCurrentRate()},renderWeather(e){const t=document.querySelector(".weather-temp");t&&(t.textContent=formatTemperature(e?.temperature))},renderTime(){const e=document.querySelector(".time-value");e&&(e.textContent=TimeService.getCurrentPHT());const t=document.querySelector(".date-value");t&&(t.textContent=TimeService.getCurrentPHTDate_Formatted())},startUpdates(){this.intervals.time=setInterval(()=>{this.renderTime()},CONFIG.TIME_UPDATE_INTERVAL),this.intervals.rateRotation=setInterval(()=>{this.rotateRate()},4e3),this.intervals.weather=setInterval(()=>{this.updateWeather()},CONFIG.WEATHER_TTL),this.intervals.exchangeRates=setInterval(()=>{this.updateExchangeRates()},CONFIG.EXCHANGE_RATE_TTL)},stopUpdates(){this.intervals.time&&(clearInterval(this.intervals.time),this.intervals.time=null),this.intervals.rateRotation&&(clearInterval(this.intervals.rateRotation),this.intervals.rateRotation=null),this.intervals.weather&&(clearInterval(this.intervals.weather),this.intervals.weather=null),this.intervals.exchangeRates&&(clearInterval(this.intervals.exchangeRates),this.intervals.exchangeRates=null)}};"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".info-bar")&&InfoBarManager.init()});