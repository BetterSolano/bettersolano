!function(){"use strict";function e(){const e=(new Date).getHours(),t=[];for(let i=0;i<6;i++){const n=(e+i)%24,a=n>=12,o=0===n?12:n>12?n-12:n,r=26+Math.floor(5*Math.random());t.push({time:`${o} ${a?"PM":"AM"}`,temperature:r,icon:n>=6&&n<18?"bi-cloud-sun-fill":"bi-moon-stars-fill"})}return{temperature:29,humidity:65,windSpeed:12,weatherCode:1,condition:"Mainly clear",icon:"bi-cloud-sun-fill",hourlyForecast:t,isFallback:!0,timestamp:Date.now()}}console.log("=== weather-map.js: Script loading started ===");const t={CACHE_KEY:"solano_weather_cache",CACHE_TTL:18e5,API_URL:"https://api.open-meteo.com/v1/forecast",COORDINATES:{lat:16.5167,lon:121.1833},mapWeatherCode:e=>({0:{condition:"Clear sky",icon:"bi-sun-fill"},1:{condition:"Mainly clear",icon:"bi-cloud-sun-fill"},2:{condition:"Partly cloudy",icon:"bi-cloud-sun-fill"},3:{condition:"Overcast",icon:"bi-clouds-fill"},45:{condition:"Foggy",icon:"bi-cloud-fog-fill"},48:{condition:"Depositing rime fog",icon:"bi-cloud-fog-fill"},51:{condition:"Light drizzle",icon:"bi-cloud-drizzle-fill"},53:{condition:"Moderate drizzle",icon:"bi-cloud-drizzle-fill"},55:{condition:"Dense drizzle",icon:"bi-cloud-drizzle-fill"},61:{condition:"Slight rain",icon:"bi-cloud-rain-fill"},63:{condition:"Moderate rain",icon:"bi-cloud-rain-fill"},65:{condition:"Heavy rain",icon:"bi-cloud-rain-heavy-fill"},80:{condition:"Rain showers",icon:"bi-cloud-rain-fill"},95:{condition:"Thunderstorm",icon:"bi-cloud-lightning-rain-fill"}}[e]||{condition:"Partly cloudy",icon:"bi-cloud-sun-fill"}),cacheWeather(e){try{if("undefined"==typeof localStorage)return;localStorage.setItem(this.CACHE_KEY,JSON.stringify({data:e,expiresAt:Date.now()+this.CACHE_TTL}))}catch(e){console.warn("Cache write failed:",e)}},getCachedWeather(){try{if("undefined"==typeof localStorage)return null;const e=localStorage.getItem(this.CACHE_KEY);if(!e)return null;const t=JSON.parse(e);if(t&&t.data&&Date.now()<t.expiresAt)return t.data;localStorage.removeItem(this.CACHE_KEY)}catch(e){console.warn("Cache read failed:",e);try{localStorage.removeItem(this.CACHE_KEY)}catch(e){}}return null},async fetchWeather(){if(function(){try{return"file:"===window.location.protocol}catch(e){return!1}}())return console.log("Weather: File protocol detected, using mock data"),e();try{const e=this.getCachedWeather();if(e)return console.log("Weather: Using cached data (expires in "+Math.round((e.timestamp+this.CACHE_TTL-Date.now())/1e3)+"s)"),e}catch(e){console.warn("Weather: Cache check failed",e)}console.log("Weather: Fetching live data from Open-Meteo API...");try{const e=new AbortController,t=setTimeout(()=>e.abort(),1e4),i=new URLSearchParams({latitude:this.COORDINATES.lat,longitude:this.COORDINATES.lon,current:"temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m",hourly:"temperature_2m,weather_code",timezone:"Asia/Manila",forecast_days:1}),n=`${this.API_URL}?${i}`;console.log("Weather: API URL:",n);const a=await fetch(n,{signal:e.signal});if(clearTimeout(t),!a.ok)throw new Error(`API error: ${a.status}`);const o=await a.json();console.log("Weather: API response received:",o);const r=this.transformApiResponse(o);return this.cacheWeather(r),console.log("Weather: ✓ Live data fetched successfully - Temp:",r.temperature+"°C"),r}catch(t){return console.warn("Weather: ✗ API fetch failed, using mock data -",t.message),e()}},transformApiResponse(t){try{const e=t.current,i=t.hourly,{condition:n,icon:a}=this.mapWeatherCode(e.weather_code),o=(new Date).getHours(),r=[];for(let e=0;e<6&&o+e<i.time.length;e++){const t=o+e,{icon:n}=this.mapWeatherCode(i.weather_code[t]),a=new Date(i.time[t]);r.push({time:a.toLocaleTimeString("en-PH",{hour:"numeric",hour12:!0}),temperature:Math.round(i.temperature_2m[t]),icon:n})}return{temperature:Math.round(e.temperature_2m),humidity:e.relative_humidity_2m,windSpeed:Math.round(e.wind_speed_10m),condition:n,icon:a,hourlyForecast:r,isFallback:!1,timestamp:Date.now()}}catch(t){return console.warn("Weather: Transform failed, using mock",t),e()}}},i={render(e,t){if(e)try{const i=t.hourlyForecast.slice(0,4).map(e=>`\n                <div class="weather-hour" role="listitem">\n                    <span class="weather-hour-time">${e.time}</span>\n                    <i class="bi ${e.icon}" aria-hidden="true"></i>\n                    <span class="weather-hour-temp">${e.temperature}°</span>\n                </div>\n            `).join(""),n=t.isFallback?'<span style="font-size:0.65rem;color:rgba(255,255,255,0.5);margin-left:4px;" title="Using fallback data">(Demo)</span>':'<span style="font-size:0.65rem;color:#06a77d;margin-left:4px;" title="Live data from Open-Meteo API">●</span>';e.innerHTML=`\n                <div class="weather-widget" role="region" aria-label="Current weather in Solano">\n                    <div class="weather-current">\n                        <div class="weather-current-icon" aria-hidden="true">\n                            <i class="bi ${t.icon}"></i>\n                        </div>\n                        <div class="weather-current-info">\n                            <div class="weather-current-temp" aria-label="Temperature ${t.temperature} degrees Celsius">${t.temperature}°C</div>\n                            <div class="weather-current-condition" aria-label="Condition: ${t.condition}">${t.condition}${n}</div>\n                            <div class="weather-current-location">\n                                <i class="bi bi-geo-alt" aria-hidden="true"></i> Solano, Nueva Vizcaya\n                            </div>\n                        </div>\n                    </div>\n                    <div class="weather-stats" role="list" aria-label="Weather details">\n                        <div class="weather-stat" role="listitem" aria-label="Humidity ${t.humidity} percent">\n                            <i class="bi bi-droplet" aria-hidden="true"></i>\n                            <span>${t.humidity}%</span>\n                        </div>\n                        <div class="weather-stat" role="listitem" aria-label="Wind speed ${t.windSpeed} kilometers per hour">\n                            <i class="bi bi-wind" aria-hidden="true"></i>\n                            <span>${t.windSpeed} km/h</span>\n                        </div>\n                    </div>\n                    <div class="weather-hourly" role="list" aria-label="Hourly forecast">\n                        ${i}\n                    </div>\n                </div>\n            `,e.setAttribute("data-weather-loaded","true")}catch(t){console.error("Weather: Render failed",t),this.renderError(e)}},renderLoading(e){e&&(e.innerHTML='\n            <div class="weather-loading" data-loading="true" aria-busy="true" aria-label="Loading weather data">\n                <div class="weather-current">\n                    <div class="skeleton-circle"></div>\n                    <div class="weather-current-info">\n                        <div class="skeleton-text skeleton-lg"></div>\n                        <div class="skeleton-text skeleton-md" style="margin-top:8px;"></div>\n                        <div class="skeleton-text skeleton-sm" style="margin-top:8px;"></div>\n                    </div>\n                </div>\n                <div class="weather-stats">\n                    <div class="skeleton-text skeleton-stat"></div>\n                    <div class="skeleton-text skeleton-stat"></div>\n                </div>\n                <div class="weather-hourly">\n                    <div class="skeleton-hour"></div>\n                    <div class="skeleton-hour"></div>\n                    <div class="skeleton-hour"></div>\n                    <div class="skeleton-hour"></div>\n                </div>\n            </div>\n        ')},renderError(e,t){e&&(e.innerHTML='\n            <div class="weather-error" role="alert">\n                <div class="weather-error-content">\n                    <i class="bi bi-cloud-slash" aria-hidden="true"></i>\n                    <p>Weather data unavailable</p>\n                    <button type="button" class="btn btn-sm btn-primary weather-retry-btn" onclick="window.WeatherMapInit && window.WeatherMapInit()">\n                        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Retry\n                    </button>\n                </div>\n            </div>\n        ',e.setAttribute("data-weather-loaded","error"))}},n={SOLANO_CENTER:[16.5167,121.1833],DEFAULT_ZOOM:14,map:null,init(e){const t=document.getElementById(e);if(!t)return console.error("Map: Container not found"),null;if(this.map)return console.log("Map: Already initialized, resizing"),this.map.invalidateSize(),this.map;if(console.log("Map: Starting initialization..."),console.log("Map: Leaflet available:","undefined"!=typeof L),"undefined"!=typeof L)return this.initLeaflet(t);this.renderLoading(t);let i=0;const n=setInterval(()=>{i++,console.log(`Map: Retry attempt ${i}/10`),"undefined"!=typeof L?(clearInterval(n),this.initLeaflet(t)):i>=10&&(clearInterval(n),console.warn("Map: Leaflet failed to load after retries"),this.renderTextFallback(t))},500);return null},renderLoading(e){e.innerHTML='\n            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:300px;background:#f5f5f5;">\n                <i class="bi bi-map" style="font-size:2.5rem;color:#0032a0;opacity:0.4;"></i>\n                <p style="color:#888;margin-top:0.5rem;font-size:0.875rem;">Loading map...</p>\n            </div>\n        '},renderTextFallback(e){e.innerHTML='\n            <iframe \n                width="100%" \n                height="300" \n                frameborder="0" \n                scrolling="no" \n                marginheight="0" \n                marginwidth="0" \n                src="https://www.openstreetmap.org/export/embed.html?bbox=121.1633%2C16.5017%2C121.2033%2C16.5317&layer=mapnik&marker=16.5167%2C121.1833"\n                style="border:0;display:block;"\n                title="Map of Solano, Nueva Vizcaya"\n                loading="lazy">\n            </iframe>\n        ',e.setAttribute("data-map-loaded","iframe")},initLeaflet(e){try{console.log("Map: Initializing Leaflet..."),e.innerHTML="",this.map=L.map(e,{center:this.SOLANO_CENTER,zoom:this.DEFAULT_ZOOM,scrollWheelZoom:!1,zoomControl:!0,keyboard:!0,keyboardPanDelta:80}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(this.map);return L.marker(this.SOLANO_CENTER).addTo(this.map).bindPopup("<strong>Solano Municipal Hall</strong><br>Nueva Vizcaya 3708"),e.setAttribute("data-map-loaded","leaflet"),setTimeout(()=>{this.map&&(this.map.invalidateSize(),console.log("Map: Resize complete"))},100),setTimeout(()=>{this.map&&this.map.invalidateSize()},500),console.log("Map: Leaflet initialized successfully"),this.map}catch(t){return console.error("Map: Leaflet initialization failed:",t),this.renderTextFallback(e),null}}};async function a(){console.log("Weather-Map: Initializing...");const a=document.getElementById("weather-container"),o=document.getElementById("map-container");if(a)try{i.renderLoading(a);const e=await t.fetchWeather();i.render(a,e)}catch(t){console.error("Weather: Init failed",t),i.render(a,e())}if(o)try{n.init("map-container")}catch(e){console.error("Map: Init failed",e),n.renderTextFallback(o)}}window.WeatherMapInit=a,console.log("=== weather-map.js: WeatherMapInit exposed to window ==="),function(){function e(){console.log("=== weather-map.js: Calling WeatherMapInit() ==="),a()}console.log("=== weather-map.js: Auto-init IIFE executing ==="),console.log("Document readyState:",document.readyState),"loading"===document.readyState?(console.log("=== weather-map.js: Waiting for DOMContentLoaded ==="),document.addEventListener("DOMContentLoaded",e)):(console.log("=== weather-map.js: DOM already loaded, initializing immediately ==="),e())}(),console.log("=== weather-map.js: Script loading completed ==="),"undefined"!=typeof module&&module.exports&&(module.exports={WeatherService:t,WeatherUI:i,MapComponent:n,getMockWeather:e})}();